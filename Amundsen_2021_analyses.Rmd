---
title: "Amundsen 2021 - Analyses"
author: "Pierre Priou - pierre.priou@mi.mun.ca"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_float: true
    toc_collapsed: true
---

```{r r-setup, message=FALSE}
# Load packages
library(tidyverse)                # Tidy code
library(lubridate)                # Date handling
library(dtplyr)                   # Speed up code
library(plotly)                   # Interactive plots
library(oce)                      # Speed of sound and absorption coefs.
library(cowplot)                  # Multiple plots
library(rgdal)                    # Read shapefiles
library(marmap)                   # Bathymetry data of the Arctic Ocean
library(cmocean)                  # Colour palettes
source("R/sv_depth_correction_fm.R")    # Correct Sv vertical profiles
# Suppress summarise() warning
options(dplyr.summarise.inform = F)
# Theme for figures
theme_set(theme_bw())
theme_update(panel.grid = element_blank(), 
             panel.border = element_blank(), 
             axis.line = element_line(),
             axis.text = element_text(size = 10),
             axis.title = element_text(size = 11),
             legend.title = element_text(size = 11),
             strip.text.x = element_text(size = 11, face = "plain", 
                                         hjust = 0.5),
             strip.background = element_rect(colour = "transparent", 
                                             fill = "transparent"),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             plot.margin = unit(c(0.05, 0.05, 0.05, 0.05), "in"))
```

# Introduction

Diel vertical migrations (DVM) from ocean's depth to the surface are a ubiquitous pattern of pelagic organisms of the global ocean (Cohen 2009). While DVM are ultimately driven by predator-prey interactions (e.g., Urmy et al. 2021), environmental factors are known to define the extent and timing of these migrations. For example, temperature and oxygen can influence DVM patterns (Bianchi et al. 2013, Benoit-Bird et al. 2015?), but light penetration is considered to trump those other environmental cues (Asknes et al. 2017). Fish living in the mesopelagic zone, where the light intensity is between 10^-9^ to 10^-1^ μmol quanta m^2^ s^-1^ (Kaartvedt et al., 2019), track a narrow range of ambient light levels—their light comfort zone (Rostad 2016)—and migrate vertically following those isolumes during the day-night cycle. They track their antipredation window, which enhance their feeding chances while reducing mortality through predation (Clark & Levy, 1988). 

In the Arctic, the extreme light regime has the potential to disrupt traditional DVM patterns, which could prevent the establishment of viable mesopelagic fish populations in the Arctic (Kaartvedt 2008). Yet, DVM can occur during the polar night at low light levels (Berge et al. 2009) and mesopelagic fish are not as seldom in the Arctic as previously thought, and are, in fact, widespread in high Arctic Seas (Priou et al. *in prep*). However, their survival mechanisms remain elusive. For most of the year mesopelagic fish remain segregated from their favourite preys (Gjøsæter et al. 2017, Knutsen et al. 2017, Geoffroy et al. 2019, Priou et al. 2021). Autumn has been suggested to be a key period for feeding of mesopelagic fish, as the photoperiod alternates between day and night---favouring large scale DVM---and their copepod preys occupy most of the water column (**ref**).

The goals of this study were two-fold, (1) investigate whether mesopelagic organisms conduct DVM in autumn, and (2) if those organisms were associated to a specific range of ambient light levels matching those of the global ocean. Here, we deployed a combination of acoustic, optical, and environmental sensors and nets to document the vertical distribution of pelagic fish and zooplankton in northern Baffin Bay in autumn. We test the hypothesis that pelagic organisms follow a narrow range of light levels (different from the "new" definition of the mesopelagic zone) and thus conduct DVM.

# Materials and methods

```{r load-bathy-coast, message=FALSE}
# Load data
bathy <- read_csv("data/bathy/bathy_BaffinBay_-105;-45;65;82_res2.csv",
                  show_col_types = F) %>%
  mutate(depth_d = factor(case_when(between(depth, -50, Inf) ~ "0-50",
                                    between(depth, -100, -50) ~ "50-100",
                                    between(depth, -200, -100) ~ "100-200",
                                    between(depth, -500, -200) ~ "200-500",
                                    between(depth, -1000, -500) ~ "500-1000",
                                    between(depth, -Inf, -1000) ~ "1000-2500"),
                          levels = c("0-50", "50-100", "100-200", "200-500", "500-1000", "1000-2500")))
coast <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% # Coastlines
  fortify() %>%
  rename(lon = long,
         region = id)
# glacier <- readOGR("data/bathy/ne_10m_glaciated_areas.shp", verbose = F) %>% # Glaciers
#   fortify() %>%
#   rename(lon = long,
#          region = id)
```

The CCGS *Amundsen* surveyed northern Baffin Bay between between October 12 and 27, 2021 (Figure 1) during the DarkEdge campaign. We deployed our instruments at three stations, north of Coburg Island, in Smith Sound, and Jones Sound in varying sea ice conditions (Figure 1).

## Environmental data

A Seabird SBE911+ Conductivity Temperature Depth sensor (CTD) collected vertical profiles of temperature, salinity, and pressure. The CTD rosette was also equipped with an oxygen sensor (Seabird SBE43), a transmissometer (Wetlab Cstar), two fluorimeters (Seabird SCF and ECO CDOM), two PAR sensors (one underwater Biospherical Instruments PAR-QCP 2300, and surface Biospherical Instruments PAR-QCP 2200), and a nitrate sensor (Satlantic). We only considered downcast data. 

```{r load-CTD}
# Load CTD data
CTD_raw <- read_csv("data/CTD/CTD_Amundsen_2021_all_leg.csv", show_col_types = F)
```

Select relevant CTD stations (2, 13, 25, 26, 28, 29, and 40).

```{r CTD-cast-selection}
CTD <- CTD_raw %>%
  # Select data from leg 5
  filter(leg == 5) %>%
  # Select CTD casts
  filter(cast_number %in% c(2, 13, 25, 26, 28, 29, 40)) %>%
  # Select variables of interest
  dplyr::select(station, cast_number, date, lat, lon, bottom_depth, depth_min, depth_max, PRES, TE90,
                PSAL, SIGM, SPVA, VAIS, SIGT, POTM, SIGP, FRET, SVEL, ASAL, 
                CONT, D_CT) %>% 
  # Rename variable
  rename(date_start_CTD = date) %>%
  # Calculate depth
  mutate(depth = round(swDepth(pressure = PRES, latitude = lat))) %>% 
  # Summarise data per 1 m depth bin
  group_by(date_start_CTD, station, cast_number, lat, lon, bottom_depth,
           depth_min, depth_max, depth) %>%
  summarise_all(mean) %>%
  ungroup()
```

Cast 25 is full of `NaNs` so I replace these values with the appropriate data that I processed myself. 

```{r CTD-add-CTD25}
# Load CTD25 data
CTD25 <- read_csv("data/CTD/CTD25_1m.csv", show_col_types = F) 

CTD <- CTD %>%
  # Combine CTD25
  left_join(., CTD25, by = c("date_start_CTD", "station",
                             "cast_number", "depth")) %>%
  # Update values of CTD25
  mutate(PRES = if_else(cast_number == 25 & is.na(PRES) == T, PRES_25, PRES),
         TE90 = if_else(cast_number == 25 & is.na(TE90) == T, TE90_25, TE90),
         PSAL = if_else(cast_number == 25 & is.na(PSAL) == T, PSAL_25, PSAL),
         SIGT = if_else(cast_number == 25 & is.na(SIGT) == T, SIGT_25, SIGT),
         SIGP = if_else(cast_number == 25 & is.na(SIGP) == T, SIGP_25, SIGP)) %>%
  # Remove CTD25 variables
  dplyr::select(-PRES_25, -TE90_25, -PSAL_25, -FLOR_25, -SIGT_25, -SIGP_25)

# Remove CTD25
rm(CTD25)
```


Since there was no pressure sensor on the WBAT, I need to find the depth at which data was collected. To do that I match the WBAT date to the date of unprocessed CTD data. Thus, I use the unprocessed CTD data and extract the mean depth of the CTD at each second (see `R\CTD_date_depth.R` for more details on this data processing).

```{r CTD-date-depth-loading}
CTD_date_depth <- read_csv("data/CTD/CTD_date_depth.csv", show_col_types = F)
```

```{r plot-turning-points}
# ggplotly(CTD_date_depth %>% 
#   # filter(!cast_number %in% c(2, 13)) %>%
#   filter(cast_number == 2) %>%
#   ggplot(aes(x = date, y = depth, col = cast)) +
#   geom_point(size = 0.25) +
#   scale_y_reverse() +
#   facet_wrap(~ cast_number, scales = "free"))
```

## Wideband Acoustic Transceiver (WBAT)

Broadband acoustic backscatter was recorded between 36-45 kHz and 283-333 kHz with a Simrad WBAT mounted on the CTD rosette. The transducers were facing sideward, pulse length was set to 2048 μs, and ping rate to 0.5 Hz. Acoustic data was analyzed with Echoview 12. WBAT acoustic backscatter data was manually inspected and cleaned. Data within the near-field was excluded (5.00 m). Using pulse compressed data, we exported mean volume backscatter strength (Sv; dB re 1 m^-1^) and nautical area scattering coefficient (s~A~; m^2^ nmi^-2^) at a resolution of 1 ping per 1 m range.

```{r load-WBAT-data}
# Load WBAT data
WBAT_raw <- list.files("data/WBAT", pattern = "*.csv", full.names = T) %>% 
  set_names() %>%
  # Read files
  map_dfr(.f = ~read_csv(., show_col_types = F), .id = "filename") %>% 
  # Tidy data
  unite(date_WBAT, Date_S, Time_S, sep = " ", remove = F) %>%
  mutate(station = str_extract(filename, pattern = "[A-Z]{2}[0-9]{3}"),
         station = if_else(str_detect(station, "BB") == T, "BB2", station),
         CTD_id = str_extract(filename, pattern = "CTD[0-9]{2}"),
         CTD_id = as.numeric(str_remove(CTD_id, pattern = "CTD")),
         date_WBAT = round_date(ymd_hms(date_WBAT, tz = "UTC"), "second")) %>%
    rename(range = Layer_depth_min,
           frequency = Frequency,
           cast_number = CTD_id)
```

The WBAT was activated with a pressure switch at 8 m depth. This switch malfunctioned on October 18^th^. Therefore, for CTD casts 2 and 13 I used the time of the first recorded ping to match CTD time at 8 m depth. For the other casts I used the time at which the CTD reached the seafloor and matched it with the corresponding ping where we see the seafloor on the WBAT. At BB2, the CTD did not reach the seafloor, thus I used an easily observable stop of the CTD on the upcast to match WBAT and CTD times.

```{r combine-WBAT-CTD-depth}
WBAT_time_corrected <- WBAT_raw %>%
  dplyr::select(date_WBAT, station, cast_number, Ping_S, frequency, range, 
                Sv_mean, NASC) %>%
  # Fix dates
  mutate(date = 
           case_when(cast_number == 2 ~ date_WBAT - hours(4) + seconds(41),
                     cast_number == 13 ~ date_WBAT - hours(4) + seconds(14),
                     cast_number == 25 ~ date_WBAT + seconds(16),
                     cast_number == 26 ~ date_WBAT + seconds(16),
                     cast_number == 28 ~ date_WBAT + seconds(16),
                     cast_number == 29 ~ date_WBAT + seconds(16),
                     cast_number == 40 ~ date_WBAT - hours(4) + seconds(16))) %>%
  # Combine CTD date at depth and WBAT date
  left_join(., CTD_date_depth, by = c("cast_number", "date")) %>%
  # Round depth
  rename(depth_raw = depth) %>%
  mutate(depth = floor(depth_raw)) %>%
  # Reorder variables
  dplyr::select(date_WBAT, date_start_CTD, station, cast_number, cast,
                frequency, depth_raw, depth, range, Sv_mean, NASC)
```

Because the WBAT was mounted on a probe and collected data vertically, I corrected S~V~ for changes in speed of sound and absorption coefficients with depth. To do that, I create a CTD dataset with all the required variables.

```{r CTD-sound-speed-abs-coef}
# CTD with speed of sound and absorption coeffiecients
CTD_Sv_correction <- CTD %>%
    # Calculate speed of sound (m/s) and absorption coefficients (dB/m) at 38 and 333 kHz
    mutate(sound_speed = 
             swSoundSpeed(salinity = PSAL, temperature = TE90, pressure = PRES,
                          longitude = lon, latitude = lat, eos = "gsw"),
           abs38 = 
             swSoundAbsorption(frequency = 38000, salinity = PSAL,
                               temperature = TE90, pressure = PRES, pH = 8,
                               formulation = "francois-garrison"),
           abs333 = 
             swSoundAbsorption(frequency = 333000, salinity = PSAL,
                               temperature = TE90, pressure = PRES, pH = 8, 
                               formulation = "francois-garrison")) %>%
  # Keep only relevant variables
  dplyr::select(date_start_CTD, station, cast_number, lat, lon, depth, 
                sound_speed, abs38, abs333)
```

Then, I match that CTD dataset with the WBAT data and correct Sv. 

```{r Sv-correction-WBAT}
WBAT <- WBAT_time_corrected %>%
  # Combine WBAT and speed of sound and absorption coefficients
  left_join(., CTD_Sv_correction, 
            by = c("date_start_CTD", "station", "cast_number", "depth")) %>%
  # Correct Sv according to sound speed and absorption for every depth bin
  mutate(Sv_cor = 
           case_when(frequency == 38 ~ 
                       sv_depth_correction_fm(Sv = Sv_mean,
                                              range = range,
                                              f_nominal = 38,
                                              f_start = 36, 
                                              f_end = 45,
                                              c_cal = 1450,
                                              t_cal = 0.12351,
                                              psi_cal = -12.5,
                                              p_cal = 450,
                                              abs_depth_cal = 300,
                                              pH_cal = 8,
                                              sal_cal = 34,
                                              temp_cal = 0,
                                              lat = lat,
                                              c_new = sound_speed, 
                                              abs_new = abs38),
                     frequency == 333 ~ 
                       sv_depth_correction_fm(Sv = Sv_mean,
                                              range = range,
                                              f_nominal = 38,
                                              f_start = 36, 
                                              f_end = 45,
                                              c_cal = 1450,
                                              t_cal = 0.12351,
                                              psi_cal = -12.5,
                                              p_cal = 450,
                                              abs_depth_cal = 300,
                                              pH_cal = 8,
                                              sal_cal = 34,
                                              temp_cal = 0,
                                              lat = lat,
                                              c_new = sound_speed, 
                                              abs_new = abs333))) %>%
  dplyr::select(-sound_speed, -abs38, -abs333, -depth_raw)

# Remove unused variables
rm(WBAT_time_corrected)
```

**FREQUENCY RESPONSES**

## Underwater Vision Profiler 6 (UVP)

The Underwater Vision Profiler 6 (UVP) was mounted on the CTD rosette and collected images throughout the water column. Pictures were sorted according to taxonomic composition using EcoTaxa (ref). I load the entire UVP dataset.

```{r load-UVP}
# Load UVP data
UVP_raw <- read_csv("data/UVP/plank_PC_values.csv", show_col_types = F)
```

Then, I select for the relevant variables and bin data in 10 m.

```{r tidy-UVP}
UVP <- UVP_raw %>%
  # Rename variables to match other datasets
  rename(cast_number = ctd_file, 
         depth_UVP = depth,
         group = taxon) %>%
  # Tidy variables
  unite(date_UVP, date, time, sep = " ") %>%
  mutate(date_UVP = ymd_hms(date_UVP),
         cast_number = as.numeric(cast_number),
         taxa = 
           case_when(str_detect(lineage, "Amphipoda") == T ~ "Amphipod",
                     str_detect(lineage, "Annelida") == T ~ "Annelid",
                     str_detect(lineage, "Appendicularia") == T ~ "Appendicularia",
                     str_detect(lineage, "Chaetognatha") == T ~ "Chaetognath",
                     str_detect(lineage, "Cnidaria") == T ~ "Cnidaria",
                     str_detect(lineage, "Copepoda") == T ~ "Copepod",
                     str_detect(lineage, "Ctenophora") == T ~ "Ctenophore",
                     str_detect(lineage, "Eumalacostraca") == T ~ "Eumalacostraca",
                     str_detect(lineage, "Limacinidae") == T ~ "Limacinidae",
                     str_detect(lineage, "Ostracoda") == T ~ "Ostracoda",
                     str_detect(lineage, "Salpida") == T ~ "Salp",
                     str_detect(lineage, "Siphonophorae") == T ~ "Siphonophore",
                     str_detect(lineage, "Rhizaria") == T ~ "Rhizaria")) %>%
  # Select variables of interest
  dplyr::select(date_UVP, station, cast_number, ice, depth_UVP, group, lineage,
                taxa) %>%
  # Remove images with uncertain taxonomy
  filter(is.na(taxa) == F) %>%
  # Summarise data in 10 m bins
  mutate(depth_round = plyr::round_any(depth_UVP, 10, floor)) %>%
  group_by(station, cast_number, ice, depth_round, group, taxa) %>%
  summarise(count = n()) %>%
  ungroup() 
```

## Light data

- **C-OPS**